automation:
- alias: Turn garage lights on/off with garage door
  initial_state: true
  trigger:
  - platform: state
    entity_id: &garage_door cover.garage_door
    to:
    - 'open'
    - 'closed'
  - platform: state
    entity_id: *garage_door
    to:
    - 'open'
    - 'closed'
    for: '00:10:00'
  - platform: state
    entity_id: *garage_door
    to: 'open'
    for: &open_time '00:00:05'
  - platform: state
    entity_id: &service_door binary_sensor.garage_service_door
    to: 'off'
    for: '00:02:00'
  - platform: state
    entity_id: sun.sun
    to: 'below_horizon'
  condition:
  - "{{ trigger.from_state.state != 'unavailable' }}"
  action:
  - choose:
    # when the garage door is opened or is already open at sunset, turn the garage lights on
    - conditions:
      - condition: state
        entity_id: &garage_lights switch.garage_lights
        state: 'off'
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
      - condition: state
        entity_id: *garage_door
        state: 'open'
      sequence:
      - service: homeassistant.turn_on
        entity_id:
        - *garage_lights
        - &garage_door_lights_hold input_boolean.garage_door
      - service: input_boolean.turn_off
        entity_id: &service_door_lights_hold input_boolean.service_door

    # when the garage door is opened during the day and the lights are on, turn the garage lights off
    - conditions:
      - condition: state
        entity_id: *garage_door
        state: 'open'
        for: *open_time
      - condition: state
        entity_id: *garage_lights
        state: 'on'
      - condition: state
        entity_id: sun.sun
        state: 'above_horizon'
      sequence:
      - service: homeassistant.turn_off
        entity_id:
        - *garage_lights
        - *garage_door_lights_hold
        - *service_door_lights_hold

    # when the garage door is closed, turn the garage lights on
    - conditions:
      - "{{ trigger.to_state.state == 'closed' }}"
      - condition: state
        entity_id:
        - *garage_lights
        - &no_garage_lights input_boolean.no_garage_lights
        state: 'off'
      sequence:
      - service: homeassistant.turn_on
        entity_id:
        - *garage_lights
        - *garage_door_lights_hold
      - service: input_boolean.turn_off
        entity_id: *service_door_lights_hold

    # when the garage door is closed, turn off the no lights hold
    - conditions:
      - "{{ trigger.to_state.state == 'closed' }}"
      - condition: state
        entity_id: *no_garage_lights
        state: 'on'
      sequence:
      - service: input_boolean.turn_off
        entity_id: *no_garage_lights

    # when the garage door is closed for 10 minutes and the service door is closed, turn the garage lights off
    - conditions:
      - "{{ trigger.to_state.state in ['closed', 'off'] }}"
      - condition: state
        entity_id: *garage_lights
        state: 'on'
      - condition: state
        entity_id: *garage_door
        state: 'closed'
        for: '00:10:00'
      - condition: state
        entity_id: *service_door
        state: 'off'
        for: '00:02:00'
      sequence:
      - service: switch.turn_off
        entity_id: *garage_lights


- alias: Turn garage lights on/off with service door
  initial_state: true
  trigger:
  - platform: state
    entity_id: *service_door
    from: 'off'
    to: 'on'
  - platform: state
    entity_id: *service_door
    from: 'on'
    to: 'off'
    for: '00:02:00'
  action:
  - choose:
    # when the service door is opened and the sun is below horizon or the garage door is closed, turn on garage lights
    - conditions:
      - "{{ trigger.to_state.state == 'on' }}"
      - condition: state
        entity_id: *garage_lights
        state: 'off'
      - condition: or
        conditions:
        - condition: state
          entity_id: sun.sun
          state: 'below_horizon'
        - condition: state
          entity_id: *garage_door
          state: 'closed'
      sequence:
      - service: homeassistant.turn_on
        entity_id: 
        - *garage_lights
        - *service_door_lights_hold

    # when the service door is closed for 2 minutes, turn off garage lights
    - conditions:
      - "{{ trigger.to_state.state == 'off' }}"
      - condition: state
        entity_id: *garage_door_lights_hold
        state: 'off'
      sequence:
      - service: homeassistant.turn_off
        entity_id:
        - *garage_lights
        - *service_door_lights_hold


- alias: Turn off garage lights hold with garage lights
  initial_state: true
  trigger:
  - platform: state
    entity_id: *garage_lights
    to:
    - 'off'
  action:
  - service: input_boolean.turn_off
    entity_id:
    - *garage_door_lights_hold
    - *service_door_lights_hold


- alias: Open garage door when service door opened if leaving
  initial_state: true
  trigger:
  - platform: state
    entity_id: *service_door
    from: 'off'
    to: 'on'
  condition:
  - condition: state
    entity_id: input_boolean.leaving
    state: 'on'
  - condition: state
    entity_id: *garage_door
    state: 'closed'
  action:
  - service: cover.open_cover
    entity_id: *garage_door
  - service: input_boolean.turn_on
    entity_id: *no_garage_lights
  - service: input_boolean.turn_off
    entity_id: input_boolean.leaving


cover:
  - platform: mqtt
    name: Garage door
    command_topic: "cmnd/garage_door/POWER"
    state_topic: "stat/garage_door/status"
    availability_topic: "tele/garage_door/LWT"
    qos: 1
    payload_available: "Online"
    payload_not_available: "Offline"
    payload_open: "ON"
    payload_close: "ON"
    payload_stop: "ON"
    state_open: "open"
    state_closed: "closed"
    device_class: garage


input_boolean:
  garage_door:
  service_door:
  garage_door_lights_hold:
  service_door_lights_hold:
  no_garage_lights: